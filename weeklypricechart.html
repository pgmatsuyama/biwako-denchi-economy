<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ—¥ä»˜é¸æŠãƒãƒ£ãƒ¼ãƒˆ - å˜ä¾¡ã¨å¤ªé™½å…‰å‡ºåŠ›åˆ¶å¾¡é‡</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.1.0/dist/chartjs-plugin-annotation.min.js"></script>
  <style>
    body { font-family: sans-serif; background: #f0f8ff; padding: 2rem; text-align: center; }
    h1 { font-size: 1.5em; margin-bottom: 1em; }
    .date-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5em;
      margin-bottom: 1em;
    }
    input[type="date"] { font-size: 1em; padding: 0.3em; }
    .chart-container {
      width: 90%;
      max-width: 1000px;
      margin: 2em auto;
    }
    canvas {
      width: 100%;
    }
    .main-chart { height: 400px; }
    .controls {
      margin-top: 1em;
      display: flex;
      justify-content: center;
      gap: 0.5em;
      flex-wrap: wrap;
    }
    #weatherSummary {
      margin-top: 1em;
      font-size: 0.95em;
      color: #333;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 0.8em;
    }
    #subChartWrapper {
      height: 150px;
    }
    button {
      font-size: 1em;
      padding: 0.3em 1em;
      margin: 0.2em;
    }
  </style>
</head>
<body>
  <h1>é–¢è¥¿ã‚¹ãƒãƒƒãƒˆä¾¡æ ¼ã¨å¤ªé™½å…‰å‡ºåŠ›åˆ¶å¾¡é‡</h1>
  <div class="date-row">
    <button id="prevDay">â† å‰æ—¥</button>
    <label for="datePicker">æ—¥ä»˜ï¼š</label>
    <input type="date" id="datePicker" value="2025-04-01">
    <button id="nextDay">ç¿Œæ—¥ â†’</button>
  </div>

  <div class="controls">
    <button id="prevWeek">â‡¦ å‰é€±</button>
    <button id="weekView">ğŸ“… é€±é–“ãƒãƒ£ãƒ¼ãƒˆ</button>
    <button id="dayView" style="display: none;">ğŸ“† 1æ—¥ã®ãƒãƒ£ãƒ¼ãƒˆ</button>
    <button id="nextWeek">ç¿Œé€± â‡¨</button>
  </div>

  <div class="chart-container">
    <canvas id="chart" class="main-chart"></canvas>
    <div id="subChartWrapper">
      <canvas id="chart2"></canvas>
    </div>
  </div>

  <div id="weatherSummary"></div>

  <a class="btn" href="index.html">æˆ»ã‚‹ â†’</a>

  <script>
    let chart;
    let chart2;
    let lastMode = "day";

    Promise.all([
      fetch("data/spot_price_kansai_2024_2025.json").then(res => res.json()),
      fetch("data/eria_jukyu_2025_full_final.json").then(res => res.json()),
      fetch("data/combined_data.json").then(res => res.json())
    ]).then(([priceData, solarControlData, weatherData]) => {
      const datePicker = document.getElementById("datePicker");
      const prevDayBtn = document.getElementById("prevDay");
      const nextDayBtn = document.getElementById("nextDay");
      const weekViewBtn = document.getElementById("weekView");
      const dayViewBtn = document.getElementById("dayView");
      const prevWeekBtn = document.getElementById("prevWeek");
      const nextWeekBtn = document.getElementById("nextWeek");
      const weatherSummary = document.getElementById("weatherSummary");

      const weekdays = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];

      function updateButtonVisibility() {
        const isWeek = lastMode === "week";
        prevWeekBtn.style.display = isWeek ? "inline-block" : "none";
        nextWeekBtn.style.display = isWeek ? "inline-block" : "none";
        dayViewBtn.style.display = isWeek ? "inline-block" : "none";
        weekViewBtn.style.display = isWeek ? "none" : "inline-block";
      }

      function renderWeather(dateStr, isWeek) {
        weatherSummary.innerHTML = "";
        const baseDate = new Date(dateStr);
        const loopCount = isWeek ? 7 : 1;
        for (let i = 0; i < loopCount; i++) {
          const d = new Date(baseDate);
          d.setDate(baseDate.getDate() + i);
          const yyyy = d.getFullYear();
          const mm = String(d.getMonth() + 1).padStart(2, '0');
          const dd = String(d.getDate()).padStart(2, '0');
          const key = `${yyyy}/${mm}/${dd}`;
          const weather = weatherData[key];
          if (weather) {
            const span = document.createElement("span");
            span.textContent = `${mm}/${dd} ${weather.icon} ${weather.temp.toFixed(1)}â„ƒ`;
            weatherSummary.appendChild(span);
          }
        }
      }

      function renderChart(dateStr, isWeek = false) {
        lastMode = isWeek ? "week" : "day";
        updateButtonVisibility();
        renderWeather(dateStr, isWeek);

        if (chart) chart.destroy();
        if (chart2) chart2.destroy();
        const ctx1 = document.getElementById("chart").getContext("2d");
        const ctx2 = document.getElementById("chart2").getContext("2d");

        const labels = [];
        const prices = [], controlValues = [], demands = [], solarActuals = [];

        const baseDate = new Date(dateStr);
        const loopCount = isWeek ? 7 : 1;

        for (let i = 0; i < loopCount; i++) {
          const d = new Date(baseDate);
          d.setDate(baseDate.getDate() + i);
          const yyyy = d.getFullYear();
          const mm = String(d.getMonth() + 1).padStart(2, '0');
          const dd = String(d.getDate()).padStart(2, '0');
          const key = `${yyyy}/${mm}/${dd}`;
          const priceDay = priceData[key];
          const controlDay = solarControlData[key];
          if (!priceDay || !controlDay) continue;

          priceDay.forEach((p, idx) => {
            const label = `${mm}/${dd} ${p.time}`;
            labels.push(label);
            prices.push(p.price);
            controlValues.push(controlDay[idx]["å¤ªé™½å…‰å‡ºåŠ›åˆ¶å¾¡é‡"]);
            demands.push(controlDay[idx]["ã‚¨ãƒªã‚¢éœ€è¦"]);
            solarActuals.push(controlDay[idx]["å¤ªé™½å…‰ç™ºé›»å®Ÿç¸¾"]);
          });
        }

        const noonAnnotations = labels.map((label, i) => {
          if (label.includes("12:00")) {
            return {
              type: 'line',
              scaleID: 'x',
              value: label,
              borderColor: 'red',
              borderWidth: 1,
              borderDash: [6, 6],
              label: {
                content: 'â˜¼',
                enabled: true,
                position: 'start',
                backgroundColor: 'transparent',
                color: 'red',
                font: { style: 'bold' }
              }
            };
          }
        }).filter(Boolean);

        const sharedLayout = { padding: { left: 80, right: 80 } };
        const sharedTicks = { callback: value => value.toLocaleString(), font: { size: 11 } };

        chart = new Chart(ctx1, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              { label: "é–¢è¥¿ã‚¹ãƒãƒƒãƒˆä¾¡æ ¼ (å††/kWh)", data: prices, borderColor: "blue", yAxisID: 'y', tension: 0.2 },
              { label: "å¤ªé™½å…‰å‡ºåŠ›åˆ¶å¾¡é‡ (MW)", data: controlValues, borderColor: "orange", yAxisID: 'y1', tension: 0.2 }
            ]
          },
          options: {
            responsive: true,
            layout: sharedLayout,
            interaction: { mode: 'index', intersect: false },
            stacked: false,
            plugins: {
              annotation: {
                annotations: noonAnnotations
              }
            },
            scales: {
              x: { title: { display: true, text: 'æ™‚é–“' } },
              y: { type: 'linear', position: 'left', title: { display: true, text: 'ä¾¡æ ¼ (å††/kWh)' }, beginAtZero: true, ticks: sharedTicks },
              y1: { type: 'linear', position: 'right', title: { display: true, text: 'å¤ªé™½å…‰å‡ºåŠ›åˆ¶å¾¡é‡ (MW)' }, beginAtZero: true, grid: { drawOnChartArea: false }, ticks: sharedTicks }
            }
          }
        });

        const maxDemand = Math.max(...demands);

        chart2 = new Chart(ctx2, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              { label: "ã‚¨ãƒªã‚¢éœ€è¦ (GW)", data: demands.map(v => v / 1000), borderColor: "green", yAxisID: 'y', tension: 0.2 },
              { label: "å¤ªé™½å…‰ç™ºé›»å®Ÿç¸¾ (GW)", data: solarActuals.map(v => v / 1000), borderColor: "gold", yAxisID: 'y1', tension: 0.2 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: sharedLayout,
            interaction: { mode: 'index', intersect: false },
            stacked: false,
            scales: {
              x: { display: false },
              y: {
                type: 'linear',
                position: 'left',
                title: { display: true, text: 'éœ€è¦ãƒ»ç™ºé›» (GW)' },
                beginAtZero: true,
                suggestedMax: maxDemand / 1000,
                ticks: { stepSize: 0.1, callback: value => value.toFixed(1), font: { size: 11 } }
              },
              y1: {
                type: 'linear',
                position: 'right',
                title: { display: true, text: 'å¤ªé™½å…‰ç™ºé›»å®Ÿç¸¾ (GW)' },
                beginAtZero: true,
                suggestedMax: maxDemand / 1000,
                grid: { drawOnChartArea: false },
                ticks: { stepSize: 0.1, callback: value => value.toFixed(1), font: { size: 11 } }
              }
            }
          }
        });
      }

      function changeDate(offset) {
        const currentDate = new Date(datePicker.value);
        currentDate.setDate(currentDate.getDate() + offset);
        const yyyy = currentDate.getFullYear();
        const mm = String(currentDate.getMonth() + 1).padStart(2, '0');
        const dd = String(currentDate.getDate()).padStart(2, '0');
        const nextValue = `${yyyy}-${mm}-${dd}`;
        datePicker.value = nextValue;
        renderChart(nextValue, lastMode === "week");
      }

      datePicker.addEventListener("change", e => renderChart(e.target.value, lastMode === "week"));
      prevDayBtn.addEventListener("click", () => changeDate(-1));
      nextDayBtn.addEventListener("click", () => changeDate(1));
      weekViewBtn.addEventListener("click", () => renderChart(datePicker.value, true));
      dayViewBtn.addEventListener("click", () => renderChart(datePicker.value, false));
      prevWeekBtn.addEventListener("click", () => changeDate(-7));
      nextWeekBtn.addEventListener("click", () => changeDate(7));

      renderChart(datePicker.value);
    });
  </script>
</body>
<footer style="margin-top: 2em; font-size: 0.9em; color: #555;">
  <p><strong>ã³ã‚æ¹–é›»æ± ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆâ„¢</strong><br>å‡ºå…¸ï¼š
    <ul>
      <li>é›»åŠ›ã‚¹ãƒãƒƒãƒˆä¾¡æ ¼ï¼š<a href="https://www.jepx.jp/" target="_blank">JEPXï¼ˆæ—¥æœ¬å¸é›»åŠ›å–å¼•æ‰€ï¼‰</a></li>
      <li>å¤ªé™½å…‰åˆ¶å¾¡é‡ï¼šé–¢è¥¿ã‚¨ãƒªã‚¢éœ€çµ¦å®Ÿç¸¾CSVï¼ˆ2025å¹´ï¼‰ã‚ˆã‚Šç”Ÿæˆ</li>
      <li>å¤©æ°—æƒ…å ±ï¼šæ°—è±¡åºå…¬é–‹ãƒ‡ãƒ¼ã‚¿ã‚ˆã‚Š</li>
    </ul>
  </p>
</footer>
</html>
